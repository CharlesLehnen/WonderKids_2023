```{r}

rm(list = ls())

```

```{r}

library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(tm)
library(wordcloud)
library(ggwordcloud)

library(ggplot2)
library(dplyr)
library(tidyr)
library(tm)
library(ggwordcloud)

```

```{r}

data_raw <- read_csv(file = "../data/2023_Fall_Speaker_Survey.csv")

head(data_raw)

```

```{r}


# Create a lookup table for the original column names and their shortened names
question_lookup <- data.frame(
  Original_Column = colnames(data_raw),
  Shortened_Column = c(
    "Timestamp",                # 1
    "Name",                     # 2
    "Subject",                  # 3
    "Speaker_Before",           # 4
    "Overall_Rating",           # 5
    "Inspire_Info",             # 6
    "Hands_On_Activities",      # 7
    "Background_Knowledge",     # 8
    "Engagement_Enjoyment",     # 9
    "Staff_Helpfulness",        # 10
    "Went_Well",                # 11
    "Went_Not_Well",            # 12
    "Speaker_Quote",            # 13
    "Future_Suggestions",       # 14
    "Email"                     # 15
  )
)

# Rename columns in the data to use the shortened names
data <- data_raw %>%
  rename_with(~ question_lookup$Shortened_Column[match(., question_lookup$Original_Column)])

# Check the transformed data
head(data)


```

```{r}

# Word Cloud

# Reference relevant columns
relevant_columns <- data[, c(6, 7, 11, 13)] 

# Combine text data from the relevant columns
text_data <- apply(relevant_columns, 1, paste, collapse = " ")

# Create a text corpus
corpus <- Corpus(VectorSource(text_data))

# Define additional stopwords to remove
custom_stopwords <- c("andrea", "charles")

# Combine with default English stopwords
all_stopwords <- c(stopwords("english"), custom_stopwords)

# Preprocess the text data
corpus <- tm_map(corpus, content_transformer(tolower))  # Convert to lowercase
corpus <- tm_map(corpus, removePunctuation)            # Remove punctuation
corpus <- tm_map(corpus, removeNumbers)                # Remove numbers
corpus <- tm_map(corpus, removeWords, all_stopwords)   # Remove common + custom stopwords

# Create a Term Document Matrix
tdm <- TermDocumentMatrix(corpus)

# Convert TDM to matrix and compute word frequencies
m <- as.matrix(tdm)
word_freq <- sort(rowSums(m), decreasing = TRUE)
word_freq_df <- data.frame(word = names(word_freq), freq = word_freq)

# Create the Word Cloud using ggwordcloud
ggplot(word_freq_df, aes(label = word, size = freq)) +
  geom_text_wordcloud() +
  labs(title = "Word Cloud of Speaker Feedback") +
  theme_minimal()

# Save the Word Cloud
ggsave("../outputs/word_cloud.png", width = 8, height = 6)



```


```{r}

# Box and Whisker Plot (Jittered)

# Load the dataset
data <- read_csv("../data/pre_post_test_scores.csv", show_col_types = FALSE)

# Rename columns for clarity
data <- data %>%
  rename(
    Semester = `Semester`,
    Test_Type = `Test Type`,
    STEM_Topic = `STEM Topic`,
    Class = `Class`,
    Total_Students = `Total Students`,
    Correct = `# correct`,
    Percent = `%`
  )

# Convert N/A to NA
data[data == "N/A"] <- NA

# Convert necessary columns to numeric
data <- data %>%
  mutate(
    Total_Students = as.numeric(Total_Students),
    Correct = as.numeric(Correct),
    Percent = as.numeric(Percent)
  )

# Separate pre and post-tests
pre_tests <- data %>% filter(Test_Type == "Pre-Test")
post_tests <- data %>% filter(Test_Type == "Post-Test")

# Join pre and post-tests
improvement_data <- pre_tests %>%
  rename(Pre_Total_Students = Total_Students, Pre_Correct = Correct, Pre_Percent = Percent) %>%
  left_join(post_tests %>%
              rename(Post_Total_Students = Total_Students, Post_Correct = Correct, Post_Percent = Percent),
            by = c("Semester", "STEM_Topic", "Class"))

# Calculate improvement and remove NA values
improvement_data <- improvement_data %>%
  mutate(Improvement = as.numeric(Post_Percent) - as.numeric(Pre_Percent)) %>%
  select(Semester, Class, Improvement) %>%
  drop_na()

# Convert Semester into an ordered factor to control display order
improvement_data$Semester <- factor(improvement_data$Semester, levels = c("Spring 2023", "Fall 2023"))

# Plot the overall improvement, faceted by Class (K-2 and 3-5)
ggplot(improvement_data, aes(x = Semester, y = Improvement, fill = Semester)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.3, width = 0.2) +
  facet_wrap(~ Class) +
  labs(
    title = "Overall Improvement from Pre to Post Test by Semester and Class",
    x = "Semester",
    y = "Improvement (%)"
  ) 

# Save the plot
ggsave("../outputs/faceted_pre_post_test_improvement.png", width = 7.29, height = 4.5, dpi = 300)



```

```{r}


# Load necessary libraries
library(tidyverse)
library(gt)

# Load the data
data <- read_csv("../data/2023_Fall_Speaker_Survey.csv")

# Data Cleaning: Rename columns for better readability
data <- data %>%
  rename(
    `Overall Rating` = `Overall, how do you feel your lesson went?`,
    `Background Knowledge of Students` = `Did the students seem to have background knowledge of some of the topics addressed in your lesson?`,
    `Engagement & Enjoyment` = `Were the students engaged in the lesson and did they seem to enjoy it?`,
    `Staff Helpfulness` = `Were the Wonderkids staff helpful in preparing you and with online classroom management?`
  )

# Scale responses for comparability
data <- data %>%
  mutate(
    `Background Knowledge of Students` = `Background Knowledge of Students` * 2,
    `Engagement & Enjoyment` = `Engagement & Enjoyment` * 2,
    `Staff Helpfulness` = `Staff Helpfulness` * 2
  )

# Calculate summary statistics
summary_table <- data %>%
  select(`Overall Rating`, `Background Knowledge of Students`, `Engagement & Enjoyment`, `Staff Helpfulness`) %>%
  pivot_longer(cols = everything(), names_to = "Question", values_to = "Response") %>%
  group_by(Question) %>%
  summarize(
    Mean = mean(Response, na.rm = TRUE),
    SD = sd(Response, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

# Create a formatted table using gt
formatted_table <- summary_table %>%
  gt() %>%
  tab_header(
    title = "Lesson Ratings by Question",
    subtitle = "Fall 2023 Speaker Feedback"
  ) %>%
  cols_label(
    Question = "Survey Question",
    Mean = "Mean Response",
    SD = "Standard Deviation",
    n = "Sample Size (n)"
  ) %>%
  tab_spanner(
    label = "Response Summary",
    columns = c(Mean, SD, n)
  ) %>%
  fmt_number(
    columns = c(Mean, SD),
    decimals = 2
  ) %>%
  tab_footnote(
    footnote = "Mean and Standard Deviation calculated from speaker feedback responses. Scaled to a maximum of 10.",
    locations = cells_column_labels(columns = c(Mean, SD))
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_spanners()
  ) %>%
  tab_options(
    table.font.size = 12,
    column_labels.font.size = 14
  )

# Print the table
formatted_table


```

```{r}

# Load necessary libraries
library(ggplot2)
library(dplyr)

# Data for activities and votes
activities <- c(
  "Predator/prey simulation and make a Galapagos Ecosystem",
  "Make Your Own Compass",
  "Making Topographic Maps and Make Your Own Map",
  "Brain Hats",
  "Neurons in a Bottle",
  "Build Your Own Insect/Pasta Insect Life Cycle",
  "Candy DNA",
  "Make an Animal Cell",
  "Practice Placing Motion Capture Markers",
  "Make a Muscle"
)

votes_3_5 <- c(5, 2, 1, 4, 1, 5, 6, 1, 2, 1)
votes_k_2 <- c(1, 0, 3, 2, 2, 1, 2, 0, 0, 0)

# Combine data for K-5
data <- data.frame(
  Activity = rep(activities, 2),
  Votes = c(votes_3_5, votes_k_2),
  Group = rep(c("3-5", "K-2"), each = length(activities))
)

# Calculate mean and standard deviation for each activity across K-2 and 3-5
data_summary <- data %>%
  group_by(Activity) %>%
  summarize(
    Mean = mean(Votes),
    SD = sd(Votes),
    .groups = "drop"
  )

# Create the bar plot with error bars extending only upwards
ggplot(data_summary, aes(x = reorder(Activity, Mean), y = Mean)) +
  geom_bar(stat = "identity", width = 0.7) +
  geom_errorbar(aes(ymin = Mean, ymax = Mean + SD), width = 0.2) +  # Error bars only extend upwards
  coord_flip() +
  labs(
    title = "Favorite Activities for Grades K-5",
    x = "Activity",
    y = "Mean Votes"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 14)
  )


```


